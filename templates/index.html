<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Rdiolizer</title>
        <link rel="stylesheet" href="/static/assets/bootstrap/css/bootstrap.min.css"></link>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.1/css/font-awesome.min.css"></link>
        <link href='http://fonts.googleapis.com/css?family=Raleway+Dots' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Metrophobic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Carme' rel='stylesheet' type='text/css'>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
        {% include 'templates.html' %}
        <style type="text/css">
            html,body{margin:0;padding:0}
            body{
                width:100%;
                background-image:url(/static/img/static.gif);
            }
            h1{
                font-size:36px;
            }
            h1,h2,h3{
                font-family:'Raleway Dots', sans-serif;
                margin-top:10px;
                margin-left:10px;
                font-weight:600;
                color:#eeeeee;
                text-shadow:0px 0px 6px #c8e;
            }
            .vizs{
                background-image:url(/static/img/yeezus.jpg);
                width:61.8%;
                height:100%;
            }
            .viz{
                z-index:-1;
                width:100%;
                height:10%;
                background-color:#5E2D79;
            }
            .above{
                display:none;
                box-shadow:0px 0px 8px #000;
                opacity:0.95;
                border-radius:30px;
                z-index:1020;
                margin-left:20%;
                width:40%;
                height:40%;
                position:absolute;
                clear:none;
                padding:0;
            }
            .ab-inner{
                background-color:rgb(0,0,0);
                box-shadow:0;
                margin:0;
                padding:1%;
                width:48%;
                height:48%;
            }
            .ab-inner.lit{
                background-color:#c8e;
                box-shadow:0px 0px 10px #c8e;
            }
            .time{
                width:0%;
                height:100%;
                background-color:#c8e;
                box-shadow:1px 0px 12px #c8e;
            }
            .right{
                width:38.2%;
                height:61.8%;
                background-color:rgb(20,20,20);
            }
            .right-bottom{
                width:38.2%;
                height:38.2%;
                background-color:rgb(20,20,20);
            }
            .rb-inner{
                width:90%;
                height:100%;
                background-color:rgb(23,23,23);
            }
            .rb-time-outer{
                position:absolute;
                bottom:0;
                height:15%;
                width:34.38%;
                margin:0; padding:0;
                background-color:rgb(26,26,26);
            }
            .rb-time{
                width:0%;
                height:100%;
                margin:0; padding:0;
                background-color:#c8e;
                opacity:0.5;
                box-shadow:0px 0px 10px #c8e;
            }
            .light{
                height:6.25%;
                opacity:0.8;
                width:100%;
            }
            .light.lit{
                background-color:#c8e;
                box-shadow:0px 0px 10px #c8e;
            }
            .light.lit.blue{
                background-color:#08c;
                box-shadow:0px 0px 10px #08c;
            }
            .light.lit.red{
                /*background-color:#DD0048;
                box-shadow:0px 0px 10px #DD0048;*/
                opacity:0.6;
            }
            .light.lit.yellow{
                background-color:yellow;
                box-shadow:0px 0px 10px yellow;
            }
            .light.lit.green{
                background-color:#8ec;
                box-shadow:0px 0px 5px #8ec;
            }
            .lights{
                height:161.8%; /* golden ratio */
                width:10%;
            }
            .chroma{
                background-color:#c8e;
                box-shadow:0px 0px 10px #c8e;
                height:8.25%;
            }
            .chromas{
                height:100%;
                width:84%;
            }
            .timbre{
                background-color:#c8e;
                box-shadow:0px 0px 10px #c8e;
                height:8.25%;
            }
            .timbres{
                height:100%;
                width:6%;
            }
        </style>
    </head>
    <body>
        <div class="vizs pull-left">
            <div class="viz" data-id="9"></div>
            <div class="viz" data-id="8"></div>
            <div class="above">
                <div class="ab-inner pull-left" data-id="0"></div>
                <div class="ab-inner pull-left" data-id="1"></div>
                <div class="ab-inner pull-left" data-id="2"></div>
                <div class="ab-inner pull-left" data-id="3"></div>
            </div>
            <div class="viz" data-id="7"></div>
            <div class="viz" data-id="6"></div>
            <div class="viz" data-id="5"></div>
            <div class="viz" data-id="4"></div>
            <div class="viz" data-id="3"></div>
            <div class="viz" data-id="2"></div>
            <div class="viz" data-id="1"></div>
            <div class="viz" data-id="0"></div>
        </div>
        <div class="right pull-left">
            <div class="time pull-right"></div>
            <div class="lights pull-right">
                <div class="light" data-id="0"></div>
                <div class="light" data-id="1"></div>
                <div class="light" data-id="2"></div>
                <div class="light" data-id="3"></div>
                <div class="light" data-id="4"></div>
                <div class="light" data-id="5"></div>
                <div class="light" data-id="6"></div>
                <div class="light" data-id="7"></div>
                <div class="light" data-id="8"></div>
                <div class="light" data-id="9"></div>
                <div class="light" data-id="10"></div>
                <div class="light" data-id="11"></div>
                <div class="light" data-id="12"></div>
                <div class="light" data-id="13"></div>
                <div class="light" data-id="14"></div>
                <div class="light" data-id="15"></div>
            </div>
            <div class="chromas pull-right">
               <div class="chroma" data-id="0"></div> 
               <div class="chroma" data-id="1"></div> 
               <div class="chroma" data-id="2"></div> 
               <div class="chroma" data-id="3"></div> 
               <div class="chroma" data-id="4"></div> 
               <div class="chroma" data-id="5"></div> 
               <div class="chroma" data-id="6"></div> 
               <div class="chroma" data-id="7"></div> 
               <div class="chroma" data-id="8"></div> 
               <div class="chroma" data-id="9"></div> 
               <div class="chroma" data-id="10"></div> 
               <div class="chroma" data-id="11"></div> 
            </div>
            <div class="timbres pull-right">
               <div class="timbre" data-id="0"></div> 
               <div class="timbre" data-id="1"></div> 
               <div class="timbre" data-id="2"></div> 
               <div class="timbre" data-id="3"></div> 
               <div class="timbre" data-id="4"></div> 
               <div class="timbre" data-id="5"></div> 
               <div class="timbre" data-id="6"></div> 
               <div class="timbre" data-id="7"></div> 
               <div class="timbre" data-id="8"></div> 
               <div class="timbre" data-id="9"></div> 
               <div class="timbre" data-id="10"></div> 
               <div class="timbre" data-id="11"></div> 
            </div>
        </div>
        <div class="right-bottom pull-left">
            <div class="rb-inner pull-left">
                <h1 id="title">loading . . .</h1>
                <h3 id="artistname"></h3>
                <div class="rb-time-outer">
                    <div class="rb-time"></div>
                </div>
            </div>
        </div>
        <div id="apiswf"></div>
    <script type="text/javascript">
    _baseURL = "{{api_base}}";
    _DEBUG = {{debug}};
    _key = "{{key}}";
    _index = {{index}};
    _PL = ['t37287272','t32313249','t32961632','t35956546'];
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <script src="/static/assets/rdio/token.js"></script>
    <script type="text/javascript">
    {% if setToken %}
        playback_token = "{{token}}";
        domain = "{{domain}}";
    {% endif %}
    </script>
    <script src="/static/assets/rdio/rdio.js"></script>
    <script>
    (function(){
        window.VZ = window.VZ || {};
        VZ.imgs = {'t32313249':'withlove.jpg',
                   't32961632':'yeezus.jpg',
                   't35956546':'electric.jpg',
                   't37287272':'oneohtrix.jpg',};

        VZ.init = function(){
            VZ.beat = -1; VZ.bar = -1; VZ.seg = -1; VZ.loopsST = 0; VZ.loopsSB = -1;
            VZ.playing = false; VZ._beatReq = null;
            if(_key === '') _key = _PL[_index];
            //$('.vizs').css('background-image', 'url(/static/img/'+VZ.imgs[_PL[_index]]+')')
            Backbone.pubSub = _.extend({}, Backbone.Events);
            Backbone.pubSub.on('rdioReady', function(){
                $.get('/get-beats/'+_key, function(data){
                    VZ.beats = data.beats; VZ.segs = data.segs; VZ.bars = data.bars;
                    VZ.duration = data.duration;
                    console.log(data);
                    VZ.beatStarts = _.pluck(data.beats, 'start');
                    VZ.segStarts = _.pluck(data.segs, 'start');
                    VZ.barStarts = _.pluck(data.bars, 'start');
                    //$('.lights').html(_.template($('#lights-view').text(), {beats: data.beats}));
                    //VZ.lightClicks();
                    rdio_play(_key);
                });
            });

            Backbone.pubSub.on('playingTrackChanged', function(track){
                console.log(track)
                $('.vizs').css('background-image', 'url('+track.bigIcon+')');
                $('#title').html(track.name);
                $('#artistname').html(track.artist);
            });

            Backbone.pubSub.on('playStateChanged', function(state){
                if(state === 1){
                    VZ.playing = true;
                    requestAnimationFrame(VZ.animate);
                }else if(state === 2){
                    if(VZ.playing){
                        VZ.playing = false;
                        VZ.beat = -1; VZ.bar = -1; VZ.seg = -1; VZ.loopsST = 0, VS.loopsSB = -1, VZ._beatReq = null;
                        _index++;
                        $('.light.lit').removeClass('lit');
                        $('.light.red').removeClass('red');
                        $('.vizs').css('background-image', 'url(/static/img/'+VZ.imgs[_PL[_index]]+')');
                        $.get('/get-beats/'+_PL[_index], function(data){
                            VZ.beats = data.beats; VZ.segs = data.segs; VZ.bars = data.bars;
                            VZ.duration = data.duration;
                            VZ.beatStarts = _.pluck(data.beats, 'start');
                            VZ.beatDurs = _.pluck(data.beats, 'duration');
                            
                            VZ.segStarts = _.pluck(data.segs, 'start');
                            VZ.barStarts = _.pluck(data.bars, 'start');
                            rdio_play(_PL[_index]);
                        });
                    }
                }
            });
            Backbone.pubSub.on('positionChanged', function(pos){
                VZ.time = pos; VZ.loopsST = 0;
                $('.rb-time').animate({width: ((pos/VZ.duration)*100.0)+'%'}, 300);
            }); 
            Backbone.pubSub.on('freqData', function(arrayAsStr){
                VZ.rdioViz(arrayAsStr.split(","));
            });
            $('.rb-time-outer').click(function(e){
                VZ._beatReq = _.sortedIndex(VZ.beatStarts, (e.offsetX/$(this).width())*VZ.duration );
            });
        };
        VZ.rdioViz = function(vals){
                if(vals[1] > 1.0){
                    $('.viz').css('background-color','rgb(88, 248,77)');
                    $('.viz').css('-webkit-filter', '');
                }else if(vals[5] > 0.5){
                    $('.viz').css('background-color','orange');
                    $('.viz').css('-webkit-filter', 'invert(100%)');
                }else{
                    $('.viz').css('background-color','#5E2D79');
                    $('.viz').css('-webkit-filter', '');
                }  
                $('.vizs').css('background-size', vals[1]*80+'%');
                for(var i=0;i<vals.length;i++){
                    $('.viz[data-id="'+i+'"]').css('opacity', 0.65*parseFloat(vals[i]));
                }
        };
        VZ.animate = function(){
            if (!VZ.playing) return;
            setTimeout(function(){
                requestAnimationFrame(VZ.animate);
            }, 20);
            VZ.nxtBeat = _.sortedIndex(VZ.beatStarts, VZ.time + (0.02*VZ.loopsST))-1;
            VZ.nxtSeg = _.sortedIndex(VZ.segStarts, VZ.time + (0.02*VZ.loopsST));
            VZ.nxtBar = _.sortedIndex(VZ.barStarts, VZ.time + (0.02*VZ.loopsST))-1;
            if(VZ.nxtBeat !== VZ.beat && VZ.loopsSB > 10 || VZ.loopsSB < 0){
                VZ.beat++;
                VZ.doBeat();
            }
            if(VZ.nxtSeg !== VZ.seg){
                VZ.seg = VZ.nxtSeg;
                VZ.doSeg();
            }
            if(VZ.nxtBar !== VZ.bar){
                VZ.bar = VZ.nxtBar;
                VZ.doBar();
            }
            VZ.loopsST++; VZ.loopsSB++;
        };
        VZ.doBeat = function(){
            if(VZ.beat < 0) return;
            VZ.loopsSB = 0;
            if(VZ._beatReq !== null){
                VZ.beat = VZ._beatReq;
                VZ.time = VZ.beatStarts[VZ.beat];
                rdio_seek(VZ.time);
                VZ.loopsST = 0;
                VZ._beatReq = null;
            }
            //$('.light[data-id="'+VZ.beat+'"]').prevAll().detach().insertAfter('.light:last-child');
            if($('.light[data-id="'+VZ.beat%16+'"]').hasClass('lit')){
                $('.lit').removeClass('lit');
            }
            $('.light[data-id="'+VZ.beat%16+'"]').prevAll().addClass('lit');
            $('.light[data-id="'+VZ.beat%16+'"]').addClass('lit');
        };
        VZ.doSeg = function(){
            if(VZ.seg < 0) return;
            for(var z=0;z<VZ.segs[VZ.seg].pitches.length;z++){
                $('.chroma[data-id="'+z+'"]').css('opacity', VZ.segs[VZ.seg].pitches[z]);
            }
            for(var y=0;y<VZ.segs[VZ.seg].timbre.length;y++){
               $('.timbre[data-id="'+y+'"]').css('opacity', ((VZ.segs[VZ.seg].timbre[y]+100)/255));
            }
        };
        VZ.doBar = function(){
            $('.light.lit').toggleClass('red');
        };
        VZ.init();
    })();
    </script>
    </body>
</html>
