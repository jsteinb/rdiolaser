window.serialize=function(a){var b=[],c;for(c in a)if($.isArray(a[c]))for(var d in a[c])b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c][d]));else b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")};Backbone.pubSub=_.extend({},Backbone.Events);var templates={};$('script[type="underscore/template"]').each(function(){templates[$(this).attr("id")]=_.template($(this).text())});
var NavigationView=Backbone.View.extend({el:$("#topbar-nav"),boards:{"topbar-nav-input":"#type-board","topbar-nav-seed":"#seeds-board","topbar-nav-filter":"#filter-board"},events:{"click div.topbar-nav-btn":"selectNav"},selectNav:function(a){var b=$(a.currentTarget);"topbar-nav-refine"===b.attr("id")?this.exportPlaylist(a):this.changeSelection(a,this.boards[b.attr("id")])},changeSelection:function(a,b){$(".topbar-nav-btn").removeClass("active");$(".topbar-nav-btn").removeClass("done");$(".topbar-nav-wirebox").removeClass("active");
$(".topbar-nav-lbl").removeClass("active");$(a.currentTarget).addClass("active");$(a.currentTarget).prevAll(".topbar-nav-btn").addClass("done");$(a.currentTarget).prevAll(".topbar-nav-wirebox").addClass("active");$('.topbar-nav-lbl[data-btnid="'+$(a.currentTarget).attr("id")+'"]').addClass("active");this.showBoard(b)},renderSwitch:function(a,b){$("#seeds-board").html(templates["seeds-view-"+b]);$(".topbar-nav-btn").removeClass("done");$(".topbar-nav-btn").removeClass("active");$(".topbar-nav-wirebox").removeClass("active");
$(".topbar-nav-lbl").removeClass("active");$(a).addClass("active");$(a).prevAll(".topbar-nav-btn").addClass("done");$(a).prevAll(".topbar-nav-wirebox").addClass("active");$('.topbar-nav-lbl[data-btnid="'+$(a).attr("id")+'"]').addClass("active");this.showBoard("#seeds-board")},showBoard:function(a){$(".board").addClass("hidden");$(a).removeClass("hidden")},exportPlaylist:function(a){if(a=prompt("Playlist Name")){var b=_.map($(".playlist-row"),function(a){return $(a).data("rdio")});$.get("/export/?tracks="+
b.join()+"&name="+a,function(a){console.log("Exported playlist to http://rdio.com"+a.url)})}}}),RdioView=Backbone.View.extend({el:$("#rdio-auth"),render:function(){var a=this;$.get("/auth-info/",function(b){a.$el.html(b.display+'&nbsp;&nbsp;<i class="icon-white icon-chevron-down">')})},initialize:function(){this.render()}}),SeedTypeView=Backbone.View.extend({el:$("#type-board"),events:{"click .seed-type":"selectType","mouseover .seed-type":"hoverType","mouseout .seed-type":"unhoverType","change #pl-length-input":"changeLength"},
initialize:function(){this.render()},render:function(){console.log("rendering seedtypeview");this.$el.html(templates["select-input-view"])},selectType:function(a){a=$(a.currentTarget).data("type");$(".billboard").addClass("hidden");$(".playlist").removeClass("hidden");console.log("about to trigger yoness");Backbone.pubSub.trigger("selectType",a)},hoverType:function(a){a=$(a.currentTarget).data("type");$(".billboard").html(templates["billboard-seed-"+a])},unhoverType:function(a){$(".billboard").html(templates["billboard-main"])},
changeLength:function(a){$("#pl-length-val").text($(a.currentTarget).val())}}),SeedInputView=Backbone.View.extend({el:$("#seeds-board"),initialize:function(){this.render()}}),ArtistSeedInputView=SeedInputView.extend({activeIndex:null,typeahead:new ArtistTypeaheadView,render:function(){this.$el.html(_.template($("#seeds-view-artist").text(),{model:this.model.toJSON()}));var a=this;$(".artist-ctl").click(function(){a.activeIndex=parseInt($(this).data("index"));$("#seeds-board").addClass("hidden");$("#seeds-typeahead-board").removeClass("hidden");
a.typeahead.render();$(".artist-input").focus()})},throttleTypeahead:_.debounce(function(a,b){$.get("/type/artist/?q="+a,function(a){b(a.items)})},300),artistTypeahead:function(a){var b=this;a.typeahead({source:function(a,d){b.throttleTypeahead(a,d)},updater:function(a){console.log(b.model);var d=b.model.get("artistSeeds");d[b.activeIndex]=a;b.model.set({artistSeeds:d});b.updateImg($(".artist-ctl img").get(b.activeIndex),b.activeIndex);Backbone.pubSub.trigger("seedsChanged")}})},updateImg:function(a,
b){var c=this.model.get("artistSeeds")[b];$.get("/artist-img/?name="+c,function(b){a.src=b.url})}}),TypeaheadView=Backbone.View.extend({el:$("#seed-typeahead-board")}),ArtistTypeaheadView=TypeaheadView.extend({events:{"input input.artist-input":"artistTypeahead"},render:function(){$el.html(templates["seeds-typeahead-artist"])},artistTypeahead:function(a){_.debounce(function(a,c){$.get("/type/artist/?q="+a,function(a){console.log(a);$(".artist-results").html(_.template($("#seeds-typeahead-artist-results").text(),
{results:res}))})},300)}}),TrackTypeaheadView=TypeaheadView.extend({}),GenreTypeaheadView=TypeaheadView.extend({}),TrackSeedInputView=SeedInputView.extend({activeIndex:null,render:function(){this.$el.html(templates["seeds-view-track"]);$(".track-ctl").popover({content:'<input type="text" class="track-input" placeholder="Enter track name"></input>',html:!0,placement:"bottom",trigger:"manual"});var a=this;$(".track-ctl").click(function(){$(this).next("div.popover:visible").length?$(this).popover("hide"):
($("a").not(this).popover("hide"),$(this).popover("show"),a.activeIndex=parseInt($(this).data("index")),a.trackTypeahead($(".track-input")),$(".track-input").focus())});$(".track-ctl").blur(function(){$(this).popover("hide")})},trackTypeahead:function(a){var b=this;a.typeahead({source:function(a,b){$.get("/type/track/?q="+a,function(a){b(a.items)})},updater:function(a){console.log(b.model);var d=b.model.get("trackSeeds");d[b.activeIndex]=a;b.model.set({trackSeeds:d});$(".track-ctl").popover("hide");
b.updateImg($(".track-ctl img").get(b.activeIndex),b.activeIndex)}})},updateImg:function(a,b){console.log("TODO")}}),PlaylistSeedInputView=SeedInputView.extend({events:{},render:function(){this.$el.html(templates["seeds-view-playlist"]);$.get("/user-playlists/",function(a){$("#rdio-playlists").html()})}}),GenreSeedInputView=SeedInputView.extend({events:{"change #seed-genre":"changeGenre"},render:function(){this.$el.html(templates["seeds-view-genre"]);this.genreTypeahead($("#seed-genre"))},changeGenre:function(a){Backbone.pubSub.trigger("seedsChanged")},
genreTypeahead:function(a){var b=this;a.typeahead({source:function(a,b){$.get("/type/genre/",function(a){b(a.items)})},updater:function(a){b.model.set({genreSeed:a})}})}}),FilterView=Backbone.View.extend({el:$("#filter-board"),events:{'change input[type="range"]':"changeFilter","click button.filter-toggle":"toggleFilter","click a.open-advanced":"openAdvanced"},initialize:function(){this.render()},render:function(){this.$el.html(templates["adjust-filters-view"])},changeFilter:function(a){Backbone.pubSub.trigger("changeFilter",
{el:$(a.target).attr("id"),value:$(a.target).val()})},toggleFilter:function(a){var b=$(a.currentTarget);b.hasClass("active")?b.parents(".filter").children("input").attr("disabled",!0):b.parents(".filter").children("input").removeAttr("disabled");Backbone.pubSub.trigger("toggleFilter",{el:$(a.target).attr("id"),enabled:!b.hasClass("active")})},openAdvanced:function(a){this.$el.html(templates["advanced-filters-view"])}}),DetailView=Backbone.View.extend({el:$("#playlist-detail"),controls:{boosts:[],
excludes:[]},events:{"click button.radio-check.active":"radioCheck",'click button.genre-boost:not(".active")':"genreBoost",'click button.genre-exclude:not(".active")':"genreExclude"},radioCheck:function(a){var b=$(a.currentTarget),c=b.parents(".genre-view").data("genre");b.removeClass("active");b.hasClass("genre-boost")?this.controls.boosts=_.without(this.controls.boosts,c):b.hasClass("genre-exclude")&&(this.controls.excludes=_.without(this.controls.excludes,c));this.model.set({boosts:this.controls.boosts,
excludes:this.controls.excludes});Backbone.pubSub.trigger("changeBoosts");a.stopPropagation()},genreBoost:function(a){a=$(a.currentTarget);a.hasClass("active")||(a=a.parents(".genre-view").data("genre"),this.controls.excludes=_.without(this.controls.excludes,a),this.controls.boosts.push(a),this.model.set({boosts:this.controls.boosts,excludes:this.controls.excludes}),Backbone.pubSub.trigger("changeBoosts"))},genreExclude:function(a){a=$(a.currentTarget);a.hasClass("active")||(a=a.parents(".genre-view").data("genre"),
this.controls.boosts=_.without(this.controls.boosts,a),this.controls.excludes.push(a),this.model.set({boosts:this.controls.boosts,excludes:this.controls.excludes}),Backbone.pubSub.trigger("changeBoosts"))},reset:function(a){a&&(this.genres=a);this.render()},render:function(){var a=this.model.toJSON();this.$el.html(_.template($("#detail-view").text(),{genres:this.genres,controls:this.controls,model:a}));_.each($("img.unset"),function(a,c,d){c=$(a).parents(".ban-view").data("name");$.get("/artist-img/?name="+
c,function(c){a.src=c.url})})}}),PlaylistView=Backbone.View.extend({el:$("#base-right"),detail:null,base_url:"http://developer.echonest.com/api/v4/",api_key:"BNXHLOQDXVWCWUU3K",options:{artist:"James Brown",type:"artist-radio"},targets:{upbeat:[{target_energy:0.3,target_danceability:0.3,target_valence:0.1,target_tempo:60},{target_energy:0.4,target_danceability:0.4,target_valence:0.3,target_tempo:80},{target_energy:0.5,target_danceability:0.5,target_valence:0.5,target_tempo:100},{target_energy:0.6,
target_danceability:0.7,target_valence:0.7,target_tempo:120},{target_energy:0.7,target_danceability:0.9,target_valence:0.9,target_tempo:140}],familiar:[{target_artist_familiarity:0.3,target_song_hotttnesss:0.4},{target_artist_familiarity:0.45,target_song_hotttnesss:0.5},{target_artist_familiarity:0.6,target_song_hotttnesss:0.6},{target_artist_familiarity:0.7,target_song_hotttnesss:0.7},{target_artist_familiarity:0.8,target_song_hotttnesss:0.8}],buzz:[{target_song_hotttnesss:0.8},{target_song_hotttnesss:0.8},
{target_song_hotttnesss:0.5},{target_song_hotttnesss:null},{target_song_hotttnesss:null}],electric:[{target_acousticness:0.9},{target_acousticness:0.7},{target_acousticness:0.5},{target_acousticness:0.3},{target_acousticness:0.1}]},target_opts:{adventurous:[{variety:0.4},{variety:0.4},{variety:0.7},{variety:1},{variety:1}],buzz:[{artist_pick:"song_hotttnesss-desc"},{artist_pick:"song_hotttnesss-desc"},{artist_pick:"song_hotttnesss-desc"},{artist_pick:"song_discovery-desc"},{artist_pick:"song_discovery-desc"}]},
steers:{},steer_opts:{},session_id:null,events:{"click .playlist-row":"playSong","click .radio-check.active":"undoAction",'click .artist-add:not(".active")':"artistAdd",'click .artist-ban:not(".active")':"artistBan"},initialize:function(){var a=this;Backbone.pubSub.on("changeFilter",function(b){b.el in a.targets&&(a.steers=_.extend(a.steers,a.targets[b.el][b.value]));for(tgt in a.steers)null===a.steers[tgt]&&delete a.steers[tgt];b.el in a.target_opts&&(console.log("setting target opts"),a.steer_opts=
_.extend(a.steer_opts,a.target_opts[b.el][b.value]),a.setOptions());a.steer_fetch(a.steers,!0)});Backbone.pubSub.on("toggleFilter",function(b){a.steer_fetch(a.steers,!1)});Backbone.pubSub.on("seedsChanged",function(){a.seedsChanged()});Backbone.pubSub.on("changeBoosts",function(){a.boostsChanged()})},setOptions:function(){this.options={};var a=this.model.get("currentType");"artist"===a?(this.options.type="artist-radio",a=_.filter(this.model.get("artistSeeds"),function(a){return null!=a}),this.options.artist=
a):"track"===a?console.log("TODO"):"genre"===a?(this.options.type="genre-radio",this.options.genre=this.model.get("genreSeed")):"playlist"===a&&console.log("TODO");var a=[],b=this.model.get("boosts"),c=this.model.get("excludes");b&&(a=a.concat(_.map(b,function(a){return a+"^2"})));c&&(a=a.concat(_.map(c,function(a){return a+"^0.5"})));this.options=_.extend(this.options,this.steer_opts);console.log(this.options)},seedsChanged:function(){console.log("seeds changed!");this.setOptions();this.fetch_artists(this.options)},
boostsChanged:function(){console.log("boosts changed!");this.setOptions();this.fetch_artists(this.options)},render:function(){this.$el.html(templates["playlist-view"])},playSong:function(a){var b=$(a.currentTarget).data("rdio"),c=$(a.currentTarget).data("time");$("#time").text(c);$(".index-cell").css("display","block");$(".playing-cell").css("display","none");$(a.currentTarget).children(".index-cell").css("display","none");$(a.currentTarget).children(".playing-cell").css("display","block");rdio_play(b)},
artistAdd:function(a){a=$(a.currentTarget).parents(".artist-row").data("name");var b=this.model.get("artistSeeds"),c=_.indexOf(b,null);"undefined"!=typeof c?(b[c]=a,this.model.set("artistSeeds",b)):alert("You already have 5 artists");Backbone.pubSub.trigger("updateArtistSeeds",c)},artistBan:function(a){a=$(a.currentTarget).parents(".artist-row").data("name");var b=this.model.get("artistBans");b?(b.push(a),this.model.set({artistBans:b})):this.model.set({artistBans:[a]});Backbone.pubSub.trigger("updateDetail")},
undoAction:function(a){$(a.currentTarget).removeClass("active");a.stopPropagation()},fetch:function(a){this.url=this.base_url+"playlist/static";this.url+="?results=16";this.url+="&bucket=audio_summary&bucket=id:rdio-US&bucket=tracks&limit=true";this.url+="&api_key="+this.api_key;a&&(this.url+="&"+serialize(a))},fetch_artists:function(a){var b=this.model.toJSON();$.post("/artist-list/",a,function(a){$("#base-right").html(_.template($("#playlist-view-artists").text(),{artists:a.artists,model:b}));Backbone.pubSub.trigger("updateDetail",
a.genres)})},new_session:function(a,b){this.dyn_url=this.base_url+"playlist/dynamic/create";this.dyn_url+="?api_key="+this.api_key+"&dmca=true";this.dyn_url+="&bucket=audio_summary&bucket=id:rdio-US&bucket=tracks&limit=true";a&&(this.dyn_url+="&"+serialize(a));if(this.boosts&&0<this.boosts.length){var c={description:_.map(this.boosts,function(a){return a+"^2"})};console.log(c.description);this.dyn_url+="&"+serialize(c)}this.excludes&&0<this.excludes.length&&(c={description:_.map(this.excludes,function(a){return"-"+
a})},console.log(c.description),this.dyn_url+="&"+serialize(c));console.log(this.dyn_url);$("#debug-panel").append("<p>"+this.dyn_url+"</p>");var d=this.model.get("artistBans"),e=this;$.get(this.dyn_url,function(a){e.session_id=a.response.session_id;if(d){var c=e.base_url+"playlist/dynamic/feedback",c=c+("?api_key="+e.api_key+"&session_id="+e.session_id);d.forEach(function(a){c+="&ban_artist="+a});$.get(c,function(a){console.log(c);$("#debug-panel").append("<p>"+c+"</p>");b&&b.apply(e)})}else b&&
b.apply(e)})},fetch_dynamic:function(a,b){this.session_id&&!b?(console.log(this.session_id),this.gather_songs(this.session_id,$("#pl-length-val").text())):this.new_session(a,function(){this.gather_songs(this.session_id,$("#pl-length-val").text())})},get_steer_callback:function(a){var b=function(){var b=this.base_url+"playlist/dynamic/steer",b=b+("?"+serialize(a)),b=b+("&api_key="+this.api_key),b=b+("&session_id="+this.session_id);$("#debug-panel").append("<p>"+b+"</p>");var c=this;$.get(b,function(a){c.gather_songs(c.session_id,
$("#pl-length-val").text())})},c=function(){this.gather_songs(this.session_id,$("#pl-length-val").text())};return 0<_.size(a)?b:c},steer_fetch:function(a,b){if(b||null===this.session_id)this.new_session(this.options,this.get_steer_callback(a));else{console.log("dynamic-restarting");url=this.base_url+"playlist/dynamic/restart";url+="?api_key="+this.api_key;url+="&bucket=tracks&bucket=audio_summary&limit=true&bucket=id:rdio-US";url+="&session_id="+this.session_id;this.options&&(url+="&"+serialize(this.options));
var c=this;$.get(url,function(){$("#debug-panel").append("<p>"+url+"</p>");c.get_steer_callback(a).apply(c)})}},gather_songs:function(a,b){var c=this;$("#debug-panel").append("<p>dynamic/next - sess_id: "+a+"</p>");$.get("/gather-songs?sess_id="+a+"&results="+b,function(a){console.log(a.songs);c.$el.html(_.template($("#playlist-view").text(),{songs:a.songs}));c.updateDetail()})},updateDetail:function(){var a=_.map($(".playlist-row"),function(a){return $(a).data("en")});$.post("/playlist-detail/",
{enids:a},function(a){Backbone.pubSub.trigger("updateDetail",a.genres)})}}),PlayerView=Backbone.View.extend({el:$("#player"),events:{"click #play":"sendPlay","click #pause":"sendPause","click #next":"sendNext","click #previous":"sendPrevious"},initialize:function(){Backbone.pubSub.on("playStateChanged",function(a){console.log(a);2===a||0===a||4===a?($("#pause").addClass("hidden"),$("#play").removeClass("hidden")):1==a&&($("#play").addClass("hidden"),$("#pause").removeClass("hidden"))});Backbone.pubSub.on("playingTrackChanged",
function(a){console.log(a);a=a.name+" - "+a.artist;35<a.length&&(a=a.slice(0,35)+"...");$("#player-meta").text(a)});Backbone.pubSub.on("positionChanged",function(a){var b=parseInt(a);a=parseInt(b/60);b%=60;10>b&&(b="0"+b);$("#position").text(a+":"+b)})},render:function(){this.$el.html(templates["player-view"])},sendPlay:function(){rdio_play()},sendPause:function(){rdio_pause()},sendNext:function(){rdio_next()},sendPrevious:function(){rdio_previous()}});
